From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Andrew Fernandes <andrew@fernandes.org>
Date: Mon, 20 Oct 2025 17:26:51 -0700
Subject: [PATCH] 8582: Add an Arm v8M+coprocessor variant, disabling the CDE
 extention

---
 Ghidra/Processors/ARM/certification.manifest  |  2 +
 .../Processors/ARM/data/languages/ARM.ldefs   | 38 ++++++++++++++++++-
 .../ARM/data/languages/ARM8m_cp_be.slaspec    | 19 ++++++++++
 .../ARM/data/languages/ARM8m_cp_le.slaspec    | 19 ++++++++++
 4 files changed, 77 insertions(+), 1 deletion(-)
 create mode 100644 Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
 create mode 100644 Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec

diff --git a/Ghidra/Processors/ARM/certification.manifest b/Ghidra/Processors/ARM/certification.manifest
index fc28f71729..9a7b5f78ed 100644
--- a/Ghidra/Processors/ARM/certification.manifest
+++ b/Ghidra/Processors/ARM/certification.manifest
@@ -22,6 +22,8 @@ data/languages/ARM7_le.slaspec||GHIDRA||||END|
 data/languages/ARM8_be.slaspec||GHIDRA||||END|
 data/languages/ARM8_le.slaspec||GHIDRA||||END|
 data/languages/ARM8m_be.slaspec||GHIDRA||||END|
+data/languages/ARM8m_cp_be.slaspec||GHIDRA||||END|
+data/languages/ARM8m_cp_le.slaspec||GHIDRA||||END|
 data/languages/ARM8m_le.slaspec||GHIDRA||||END|
 data/languages/ARMCortex.pspec||GHIDRA||||END|
 data/languages/ARMTHUMBinstructions.sinc||GHIDRA||||END|
diff --git a/Ghidra/Processors/ARM/data/languages/ARM.ldefs b/Ghidra/Processors/ARM/data/languages/ARM.ldefs
index fca51e9ab2..a8781ab81e 100644
--- a/Ghidra/Processors/ARM/data/languages/ARM.ldefs
+++ b/Ghidra/Processors/ARM/data/languages/ARM.ldefs
@@ -232,6 +232,24 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
+  <language processor="ARM"
+            endian="little"
+            size="32"
+            variant="v8-m"
+            version="1.107"
+            slafile="ARM8m_cp_le.sla"
+            processorspec="ARMCortex.pspec"
+            manualindexfile="../manuals/ARM.idx"
+            id="ARM:LE:32:v8-m-cp">
+    <description>ARM Cortex v8-m little endian, with co-processor</description>
+    <compiler name="default" spec="ARM.cspec" id="default"/>
+    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
+    <external_name tool="gnu" name="armv8-m.base"/>
+    <external_name tool="gnu" name="armv8-m.main"/>
+    <external_name tool="gnu" name="armv8.1-m.main"/>
+    <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
+    <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
+  </language>
   <language processor="ARM"
             endian="big"
             size="32"
@@ -250,7 +268,25 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
-  
+  <language processor="ARM"
+            endian="big"
+            size="32"
+            variant="v8-m"
+            version="1.107"
+            slafile="ARM8m_cp_be.sla"
+            processorspec="ARMCortex.pspec"
+            manualindexfile="../manuals/ARM.idx"
+            id="ARM:BE:32:v8-m-cp">
+    <description>ARM Cortex v8-m big endian, with co-processor</description>
+    <compiler name="default" spec="ARM.cspec" id="default"/>
+    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
+    <external_name tool="gnu" name="armv8-m.base"/>
+    <external_name tool="gnu" name="armv8-m.main"/>
+    <external_name tool="gnu" name="armv8.1-m.main"/>
+    <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
+    <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
+  </language>
+
   <language processor="ARM"
             endian="little"
             size="32"
diff --git a/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
new file mode 100644
index 0000000000..9c5d055611
--- /dev/null
+++ b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
@@ -0,0 +1,19 @@
+
+@define ENDIAN "big"
+@define T_VARIANT ""
+@define VERSION_5 ""
+@define VERSION_5E ""
+@define VERSION_6 ""
+@define VERSION_6K ""
+@define VERSION_6T2 ""
+@define VERSION_7 ""
+@define VERSION_7M ""
+@define VERSION_8 ""
+@define SIMD ""
+# https://github.com/NationalSecurityAgency/ghidra/issues/8391
+@define CORTEX ""
+@define VFPv3 ""
+@define VFPv4 ""
+
+@include "ARM.sinc"
+@include "ARM_CDE.sinc"
diff --git a/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec
new file mode 100644
index 0000000000..181c80b1a1
--- /dev/null
+++ b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec
@@ -0,0 +1,19 @@
+
+@define ENDIAN "little"
+@define T_VARIANT ""
+@define VERSION_5 ""
+@define VERSION_5E ""
+@define VERSION_6 ""
+@define VERSION_6K ""
+@define VERSION_6T2 ""
+@define VERSION_7 ""
+@define VERSION_7M ""
+@define VERSION_8 ""
+@define SIMD ""
+# https://github.com/NationalSecurityAgency/ghidra/issues/8391
+@define CORTEX ""
+@define VFPv3 ""
+@define VFPv4 ""
+
+@include "ARM.sinc"
+@include "ARM_CDE.sinc"
-- 
2.45.1

