From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Florian Magin <fmagin@users.noreply.github.com>
Date: Sun, 20 Sep 2020 00:16:14 +0200
Subject: [PATCH] 2290: Pass explicit pointer size to PointerDataType in ObjC2
 structure generation

Pass explicit pointer size to PointerDataType
---
 .../bin/format/objc/objc2/Objc2Category.java  | 14 +++++------
 .../bin/format/objc/objc2/Objc2Class.java     |  8 +++---
 .../bin/format/objc/objc2/Objc2ClassRW.java   | 10 ++++----
 .../objc/objc2/Objc2InstanceVariable.java     | 12 ++++-----
 .../objc/objc2/Objc2MessageReference.java     |  4 +--
 .../bin/format/objc/objc2/Objc2Method.java    |  6 ++---
 .../bin/format/objc/objc2/Objc2Property.java  |  4 +--
 .../bin/format/objc/objc2/Objc2Protocol.java  | 14 +++++------
 .../format/objc/objc2/Objc2ProtocolList.java  |  2 +-
 ...ObjectiveC2_DecompilerMessageAnalyzer.java | 25 +++++++++++--------
 10 files changed, 51 insertions(+), 48 deletions(-)

diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Category.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Category.java
index a60d58f1d5..abead0b34e 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Category.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Category.java
@@ -148,22 +148,22 @@ public class Objc2Category extends ObjcTypeMetadataStructure {
 
 		Structure struct = new StructureDataType(buffer.toString(), 0);
 
-		struct.add(new PointerDataType(STRING), pointerSize, "name", null);
+		struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "name", null);
 
 		if (cls == null) {
-			struct.add(new PointerDataType(VOID), pointerSize, "cls", null);
+			struct.add(new PointerDataType(VOID, pointerSize), pointerSize, "cls", null);
 		}
 		else {
-			struct.add(new PointerDataType(cls.toDataType()), pointerSize, "cls", null);
+			struct.add(new PointerDataType(cls.toDataType(), pointerSize), pointerSize, "cls", null);
 		}
 
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"instanceMethods", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"classMethods", null);
-		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit)), pointerSize,
+		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit), pointerSize), pointerSize,
 			"protocols", null);
-		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType(), pointerSize), pointerSize,
 			"instanceProperties", null);
 
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Class.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Class.java
index b24720c3b5..2f9624037b 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Class.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Class.java
@@ -183,17 +183,17 @@ public class Objc2Class extends ObjcTypeMetadataStructure {
 	public DataType toDataType() throws DuplicateNameException, IOException {
 		Structure struct = new StructureDataType(NAME, 0);
 
-		struct.add(new PointerDataType(struct), pointerSize, "isa", null);
-		struct.add(new PointerDataType(struct), pointerSize, "superclass", null);
+		struct.add(new PointerDataType(struct, pointerSize), pointerSize, "isa", null);
+		struct.add(new PointerDataType(struct, pointerSize), pointerSize, "superclass", null);
 		struct.add(cache.toDataType(), "cache", null);
 		struct.add(vtable.toDataType(), "vtable", null);
 
 		if (data == null) {
 			Objc2ClassRW fakeData = new Objc2ClassRW(program, state);
-			struct.add(new PointerDataType(fakeData.toDataType()), pointerSize, "data", null);
+			struct.add(new PointerDataType(fakeData.toDataType(), pointerSize), pointerSize, "data", null);
 		}
 		else {
-			struct.add(new PointerDataType(data.toDataType()), pointerSize, "data", null);
+			struct.add(new PointerDataType(data.toDataType(), pointerSize), pointerSize, "data", null);
 		}
 
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ClassRW.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ClassRW.java
index 8174bfdc71..7a399516c4 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ClassRW.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ClassRW.java
@@ -178,12 +178,12 @@ public class Objc2ClassRW extends ObjcTypeMetadataStructure {
 			struct.add(QWORD, "instanceSize", null);
 		}
 
-		struct.add(new PointerDataType(ASCII), pointerSize, "name", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(ASCII, pointerSize), pointerSize, "name", null);
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"baseMethods", null);
-		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit)), pointerSize,
+		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit), pointerSize), pointerSize,
 			"baseProtocols", null);
-		struct.add(new PointerDataType(Objc2InstanceVariableList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2InstanceVariableList.toGenericDataType(), pointerSize), pointerSize,
 			"ivars", null);
 
 		if (is32bit) {
@@ -193,7 +193,7 @@ public class Objc2ClassRW extends ObjcTypeMetadataStructure {
 			struct.add(QWORD, "weakIvarLayout", null);
 		}
 
-		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType(), pointerSize), pointerSize,
 			"baseProperties", null);
 
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2InstanceVariable.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2InstanceVariable.java
index 4e3f73d4a9..303614fba6 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2InstanceVariable.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2InstanceVariable.java
@@ -77,14 +77,14 @@ public class Objc2InstanceVariable extends ObjcTypeMetadataStructure {
 	public DataType toDataType() throws DuplicateNameException, IOException {
 		Structure struct = new StructureDataType("ivar_t", 0);
 		if (is32bit) {
-			struct.add(new PointerDataType(DWORD), pointerSize, "offset", null);
-			struct.add(new PointerDataType(STRING), pointerSize, "name", null);
-			struct.add(new PointerDataType(STRING), pointerSize, "type", null);
+			struct.add(new PointerDataType(DWORD, pointerSize), pointerSize, "offset", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "name", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "type", null);
 		}
 		else {
-			struct.add(new PointerDataType(QWORD), pointerSize, "offset", null);
-			struct.add(new PointerDataType(STRING), pointerSize, "name", null);
-			struct.add(new PointerDataType(STRING), pointerSize, "type", null);
+			struct.add(new PointerDataType(QWORD, pointerSize), pointerSize, "offset", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "name", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "type", null);
 		}
 		struct.add(DWORD, "alignment", null);
 		struct.add(DWORD, "size", null);
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2MessageReference.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2MessageReference.java
index 44c12a40e4..b82e17c1b2 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2MessageReference.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2MessageReference.java
@@ -78,8 +78,8 @@ public class Objc2MessageReference extends ObjcTypeMetadataStructure {
 	@Override
 	public DataType toDataType() throws DuplicateNameException, IOException {
 		Structure struct = new StructureDataType(NAME, 0);
-		struct.add(new PointerDataType(VOID), pointerSize, "imp", null);
-		struct.add(new PointerDataType(ASCII), pointerSize, "sel", null);
+		struct.add(new PointerDataType(VOID, pointerSize), pointerSize, "imp", null);
+		struct.add(new PointerDataType(ASCII, pointerSize), pointerSize, "sel", null);
 		return struct;
 	}
 }
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Method.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Method.java
index f08513f700..d37a024d3a 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Method.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Method.java
@@ -117,9 +117,9 @@ public class Objc2Method extends ObjcMethod {
 			struct.add(new PointerTypedef(null, VOID, 4, null, REL), "imp", comment);
 		}
 		else {
-			struct.add(new PointerDataType(STRING), pointerSize, "name", null);
-			struct.add(new PointerDataType(STRING), pointerSize, "types", null);
-			struct.add(new PointerDataType(VOID), pointerSize, "imp", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "name", null);
+			struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "types", null);
+			struct.add(new PointerDataType(VOID, pointerSize), pointerSize, "imp", null);
 		}
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
 		return struct;
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Property.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Property.java
index eebaa2bb3a..90f3218943 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Property.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Property.java
@@ -51,8 +51,8 @@ public class Objc2Property extends ObjcTypeMetadataStructure {
 	public DataType toDataType() throws DuplicateNameException, IOException {
 		Structure struct = new StructureDataType("objc_property", 0);
 
-		struct.add(new PointerDataType(ASCII), pointerSize, "name", null);
-		struct.add(new PointerDataType(ASCII), pointerSize, "name", null);
+		struct.add(new PointerDataType(ASCII, pointerSize), pointerSize, "name", null);
+		struct.add(new PointerDataType(ASCII, pointerSize), pointerSize, "name", null);
 
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
 		return struct;
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Protocol.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Protocol.java
index 646a075963..cbec59b981 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Protocol.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2Protocol.java
@@ -188,18 +188,18 @@ public class Objc2Protocol extends ObjcTypeMetadataStructure {
 			struct.add(QWORD, "isa", null);
 		}
 
-		struct.add(new PointerDataType(STRING), pointerSize, "name", null);
-		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit)),
+		struct.add(new PointerDataType(STRING, pointerSize), pointerSize, "name", null);
+		struct.add(new PointerDataType(Objc2ProtocolList.toGenericDataType(is32bit), pointerSize),
 			pointerSize, "protocols", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"instanceMethods", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"classMethods", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"optionalInstanceMethods", null);
-		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2MethodList.toGenericDataType(), pointerSize), pointerSize,
 			"optionalClassMethods", null);
-		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType()), pointerSize,
+		struct.add(new PointerDataType(Objc2PropertyList.toGenericDataType(), pointerSize), pointerSize,
 			"instanceProperties", null);
 
 		if (is32bit) {
diff --git a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ProtocolList.java b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ProtocolList.java
index 2bb3e2d393..864744c03a 100644
--- a/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ProtocolList.java
+++ b/Ghidra/Features/Base/src/main/java/ghidra/app/util/bin/format/objc/objc2/Objc2ProtocolList.java
@@ -83,7 +83,7 @@ public class Objc2ProtocolList extends ObjcTypeMetadataStructure {
 
 		for (int i = 0; i < protocols.size(); ++i) {
 			DataType dataType = protocols.get(i).toDataType();
-			struct.add(new PointerDataType(dataType), pointerSize, "protocol" + i, null);
+			struct.add(new PointerDataType(dataType, pointerSize), pointerSize, "protocol" + i, null);
 		}
 
 		struct.setCategoryPath(Objc2Constants.CATEGORY_PATH);
diff --git a/Ghidra/Features/Decompiler/src/main/java/ghidra/app/plugin/core/analysis/ObjectiveC2_DecompilerMessageAnalyzer.java b/Ghidra/Features/Decompiler/src/main/java/ghidra/app/plugin/core/analysis/ObjectiveC2_DecompilerMessageAnalyzer.java
index fc584e74e1..ee9b6eafd5 100644
--- a/Ghidra/Features/Decompiler/src/main/java/ghidra/app/plugin/core/analysis/ObjectiveC2_DecompilerMessageAnalyzer.java
+++ b/Ghidra/Features/Decompiler/src/main/java/ghidra/app/plugin/core/analysis/ObjectiveC2_DecompilerMessageAnalyzer.java
@@ -488,37 +488,40 @@ public class ObjectiveC2_DecompilerMessageAnalyzer extends AbstractAnalyzer {
 
 	private String getNameFromData(Program program, Varnode input, boolean isClass,
 			boolean isMethod, Address address, Data nameData) {
-		long offset;
-		String name;
 		if (!nameData.isDefined()) {
-			name = getLabelFromUndefinedData(program, address);
+			return getLabelFromUndefinedData(program, address);
 		}
 		else {
 			Object dataValue = nameData.getValue();
 			if (dataValue instanceof String) {
-				name = (String) dataValue;
+				String name = (String) dataValue;
 				if (!isClass && !isMethod) {
-					name = "\"" + name + "\"";
+					return "\"" + name + "\"";
+				}
+				else {
+					return name;
 				}
 			}
 			else if (dataValue instanceof Address) {
-				offset = ((Address) dataValue).getOffset();
+				long offset = ((Address) dataValue).getOffset();
 				if (offset == address.getOffset()) {
 					// Self-referencing pointer
-					name = null;
+					return null;
 				}
 				else {
-					name = getNameFromOffset(program, offset, input, isClass, isMethod);
+					return getNameFromOffset(program, offset, input, isClass, isMethod);
 				}
 			}
 			else {
-				name = getClassName(program, address);
+				String name = getClassName(program, address);
 				if (name == null) {
-					name = getValueAtAddress(program, address);
+					return getValueAtAddress(program, address);
+				}
+				else {
+					return name;
 				}
 			}
 		}
-		return name;
 	}
 
 	private String getDataName(Program program, Address address) {
-- 
2.45.1

