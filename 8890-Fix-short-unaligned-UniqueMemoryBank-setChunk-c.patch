From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Sigurdur Asgeirsson <siggi@sort.is>
Date: Mon, 19 Jan 2026 19:17:38 +0000
Subject: [PATCH] 8890: Fix short unaligned UniqueMemoryBank::setChunk calls.

---
 .../java/ghidra/pcode/memstate/UniqueMemoryBank.java   |  2 +-
 .../ghidra/pcode/memstate/UniqueMemoryBankTest.java    | 10 ++++++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/Ghidra/Framework/Emulation/src/main/java/ghidra/pcode/memstate/UniqueMemoryBank.java b/Ghidra/Framework/Emulation/src/main/java/ghidra/pcode/memstate/UniqueMemoryBank.java
index 1046daf297..649c506b14 100644
--- a/Ghidra/Framework/Emulation/src/main/java/ghidra/pcode/memstate/UniqueMemoryBank.java
+++ b/Ghidra/Framework/Emulation/src/main/java/ghidra/pcode/memstate/UniqueMemoryBank.java
@@ -132,7 +132,7 @@ public class UniqueMemoryBank extends MemoryBank {
 				word = new WordInfo();
 				map.put(offset & ALIGNMENT_MASK, word);
 			}
-			for (int i = adjustment; i < WORD_SIZE; ++i) {
+			for (int i = adjustment; i < WORD_SIZE && size > currentPosition; ++i) {
 				word.setByte(src[currentPosition], i);
 				offset += 1;
 				currentPosition += 1;
diff --git a/Ghidra/Framework/Emulation/src/test/java/ghidra/pcode/memstate/UniqueMemoryBankTest.java b/Ghidra/Framework/Emulation/src/test/java/ghidra/pcode/memstate/UniqueMemoryBankTest.java
index 0c6ea5c1fa..c82abb817a 100644
--- a/Ghidra/Framework/Emulation/src/test/java/ghidra/pcode/memstate/UniqueMemoryBankTest.java
+++ b/Ghidra/Framework/Emulation/src/test/java/ghidra/pcode/memstate/UniqueMemoryBankTest.java
@@ -152,6 +152,16 @@ public class UniqueMemoryBankTest extends AbstractGenericTest {
 		assertTrue(Arrays.equals(fourBytes, dest));
 	}
 
+	@Test
+	public void testOneByteNonAlignedWrite() {
+		byte[] oneByte = new byte[] { 0x11 };
+		uniqueBank.setChunk(0x1001, 1, oneByte);
+		byte[] dest = new byte[1];
+		int numBytes = uniqueBank.getChunk(0x1001, 1, dest, true);
+		assertEquals(1, numBytes);
+		assertTrue(Arrays.equals(oneByte, dest));
+	}
+
 	@Test
 	public void testOverlappingReadWrite() {
 		uniqueBank.setChunk(0x1000, 16, sixteenTestBytes);
-- 
2.45.1

